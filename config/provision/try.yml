---
- hosts: 'all'
  remote_user: 'root'

 
  vars:
    
    ruby_version: '2.2.1'
    
    user: 'rinykia'
    
    home: '/home/{{ user }}'
   
    rbenv_root: '{{ home }}/.rbenv'
    
    name: 'new-app'
    
    application: '{{ home }}/applications/{{ name }}'

    dbname: '{{ name }}_production'

    dbuser: '{{ user }}'

    dbpassword: '12345678'

  
  tasks:

    
    - name: 'rails | copy .rbenv-vars'
      template: 'src=configs/.rbenv-vars dest={{ application }}/shared/.rbenv-vars owner={{ user }} group={{ user }} mode=0644'

    - name: 'create db user and grant access to database'
      become: true
      become_user: postgres
      postgresql_user: db={{dbname}} name={{dbuser}} password={{dbpassword}} priv=ALL

    - name: 'ensure user does not have unnecessary privilege'
      become: true
      become_user: postgres
      postgresql_user: name={{dbuser}} role_attr_flags=NOSUPERUSER,NOCREATEDB

    - name: 'postgresql | restart service'
      service: name=postgresql state=restarted

    - name: 'postgresql | copy database.yml'
      template: 'src=configs/database.yml dest={{ application }}/shared/config/database.yml owner={{ user }} group={{ user }} mode=0644'


